extends ../layout.pug

block content
  .dias-container
    .dias-card
      h1.dias-title Días No Laborables

      .dias-grid
        .dias-form-section
          h2.dias-section-title(id="formTitle") Nuevo Día No Laboral

          form#diaForm.dias-form
            input(type="hidden" id="diaId")
            .form-group
              label(for="tipo") Tipo
              select#tipo(name="tipo" required)
                option(value="FERIADO") Feriado
                option(value="VACACIONES") Vacaciones 
                option(value="AUSENCIA") Ausencia
            .form-group 
              label(for="alcance") Alcance
              select#alcance(name="alcance" required)
                option(value="GLOBAL") Todos
                option(value="PROFESIONAL") Profesional específico
                option(value="SUCURSAL") Sucursal específica
            .form-group#groupMedico(style="display:none")
              label(for="idMedico") Médico
              select#idMedico(name="idMedico")
                option(value="") Seleccionar médico
                each m in medicos
                  option(value=m.medico_id) #{m.nombre   + ' ' + m.apellido}
            .form-group#groupSucursal(style="display:none")
              label(for="idSucursal") Sucursal
              select#idSucursal(name="idSucursal")
                option(value="") Seleccionar sucursal
                each s in sucursales
                  option(value=s.ID) #{s.nombre}
            .form-group 
              label(for="fecha_inicio") Fecha inicio
              input#fecha_inicio(type="date" name="fecha_inicio" required)
            .form-group 
              label(for="fecha_fin") Fecha fin
              input#fecha_fin(type="date" name="fecha_fin" required)
            .form-group
              label
                input(type="radio" name="all_day" value="1" checked)
                | Todo el día
              label(style="margin-left:12px")
                input(type="radio" name="all_day" value="0")
                | Rango horario
            .form-group#rangoHorario(style="display:none")
              label(for="hora_inicio") Hora inicio
              input#hora_inicio(type="time" name="hora_inicio" )
              label(for="hora_fin") Hora fin
              input#hora_fin(type="time" name="hora_fin")
            .form-group
              label(for="descripcion") Motivo
              input.dias-input(type="text" id="descripcion" name="descripcion" placeholder="Ej: Feriado nacional" required)
            .form-actions
              button#btnGuardar(type="submit" class="btn-primary") Guardar
              button#btnCancelar(type="button" class="btn-secondary" style="display:none") Cancelar edición

        .dias-list-section
          h2.dias-section-title Listado

          if dias && dias.length
            table.dias-table
              thead
                tr
                  th ID
                  th Fecha
                  th Motivo
                  th Tipo
                  th Aplica a
                  th Acciones
              tbody
                each dia in dias
                  - const m = dia.idMedico ? medicos.find(x => Number(x.medico_id) === Number(dia.idMedico)) : null
                  - const s = dia.idSucursal ? sucursales.find(x => Number(x.ID || x.id) === Number(dia.idSucursal)) : null
                  - const aplicaA = m ? `Dr.  ${(m.nombre + ' ' + m.apellido)}` : (s ? `Sucursal: ${s.nombre}` : 'Todas las sucursales')
                  - let alcance = 'GLOBAL'
                  - if (dia.idMedico)
                    - alcance = 'PROFESIONAL'
                  - else if (dia.idSucursal)
                    - alcance = 'SUCURSAL'
                  tr(
                    data-id=dia.ID
                    data-fechainicio= new Date(dia.fecha_inicio).toISOString().slice(0,10)
                    data-fechafin= new Date(dia.fecha_fin).toISOString().slice(0,10)
                    data-descripcion = dia.descripcion
                    data-tipo= dia.tipo
                    data-alcance=alcance
                    data-idmedico=dia.idMedico
                    data-idsucursal=dia.idSucursal
                    data-allday=dia.all_day
                    data-horainicio=dia.hora_inicio
                    data-horafin=dia.hora_fin
                  )
                    td= dia.ID
                    td= new Date(dia.fecha_inicio).toISOString().slice(0,10)
                    td= dia.descripcion
                    td= dia.tipo
                    td= aplicaA
                    td.dias-actions
                      button.dias-link(type="button" data-action="edit") Editar
                      button.dias-btn-danger(type="button" data-action="delete") Eliminar
          else
            p.dias-empty No hay días no laborables cargados.

  script.
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('diaForm');

      const inputId = document.getElementById('diaId');

      const selectTipo = document.getElementById('tipo');
      const selectAlcance = document.getElementById('alcance');

      const groupMedico = document.getElementById('groupMedico');
      const groupSucursal = document.getElementById('groupSucursal');

      const selectMedico = document.getElementById('idMedico');
      const selectSucursal = document.getElementById('idSucursal');

      const inputFechaInicio = document.getElementById('fecha_inicio');
      const inputFechaFin = document.getElementById('fecha_fin');

      const rangoHorario = document.getElementById('rangoHorario');
      const inputHoraInicio = document.getElementById('hora_inicio');
      const inputHoraFin = document.getElementById('hora_fin');

      const inputDescripcion = document.getElementById('descripcion');

      const formTitle = document.getElementById('formTitle');
      const btnGuardar = document.getElementById('btnGuardar');
      const btnCancelar = document.getElementById('btnCancelar');

      const hoy = new Date().toISOString().split('T')[0];
      inputFechaInicio.min = hoy;
      inputFechaFin.min = hoy;

      let editingId = null;

      function getAllDayValue() {
        const checked = document.querySelector('input[name="all_day"]:checked');
        return checked ? checked.value : '1';
      }

      function refreshAlcanceUI(preserve=false) {
        const a = selectAlcance.value;

        groupMedico.style.display = (a === 'PROFESIONAL') ? 'block' : 'none';
        groupSucursal.style.display = (a === 'SUCURSAL') ? 'block' : 'none';

        if (!preserve) {
          if (a !== 'PROFESIONAL') selectMedico.value = '';
          if (a !== 'SUCURSAL') selectSucursal.value = '';
        }
      }

      function refreshHorasUI(preserve=false) {
        const allDay = getAllDayValue();
        rangoHorario.style.display = (allDay === '0') ? 'block' : 'none';

        if (!preserve && allDay === '1') {
          inputHoraInicio.value = '';
          inputHoraFin.value = '';
        }
      }

      selectAlcance.addEventListener('change', () => refreshAlcanceUI(false));
        document.querySelectorAll('input[name="all_day"]').forEach(r => {
        r.addEventListener('change', () => refreshHorasUI(false));
      });


      refreshAlcanceUI();
      refreshHorasUI();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const tipo = selectTipo.value;
        const alcance = selectAlcance.value;

        const fecha_inicio = inputFechaInicio.value;
        const fecha_fin = inputFechaFin.value;

        const all_day = getAllDayValue(); 
        const hora_inicio = inputHoraInicio.value;
        const hora_fin = inputHoraFin.value;

        const descripcion = (inputDescripcion.value || '').trim();

        if (!tipo || !alcance) {
          showAlert('Seleccione tipo y alcance.', 'error');
          return;
        }

        if (!fecha_inicio || !fecha_fin) {
          showAlert('Seleccione fecha inicio y fecha fin.', 'error');
          return;
        }

        if (new Date(fecha_fin) < new Date(fecha_inicio)) {
          showAlert('La fecha fin no puede ser menor que la fecha inicio.', 'error');
          return;
        }

        if (!descripcion) {
          showAlert('El motivo/descripcion es obligatorio.', 'error');
          return;
        }

        let idMedico = null;
        let idSucursal = null;

        if (alcance === 'PROFESIONAL') {
          if (!selectMedico.value) {
            showAlert('Seleccione un médico.', 'error');
            return;
          }
          idMedico = Number(selectMedico.value);
        }

        if (alcance === 'SUCURSAL') {
          if (!selectSucursal.value) {
            showAlert('Seleccione una sucursal.', 'error');
            return;
          }
          idSucursal = Number(selectSucursal.value);
        }

        let horaInicioToSend = null;
        let horaFinToSend = null;

        if (all_day === '0') {
          if (!hora_inicio || !hora_fin) {
            showAlert('Complete hora inicio y hora fin o marque "Todo el día".', 'error');
            return;
          }
          if (hora_fin <= hora_inicio) {
            showAlert('La hora fin debe ser mayor a la hora inicio.', 'error');
            return;
          }
          horaInicioToSend = hora_inicio;
          horaFinToSend = hora_fin;
        }
          console.log("fecha_inicio input:", inputFechaInicio);
          console.log("fecha_inicio value:", inputFechaInicio?.value);
          console.log("fecha_fin value:", inputFechaFin?.value);
          console.log("idMedico: ", idMedico);

        const payload = {
          tipo,
          alcance,
          idMedico,     
          idSucursal,  
          fecha_inicio,
          fecha_fin,
          all_day: Number(all_day), 
          hora_inicio: horaInicioToSend,
          hora_fin: horaFinToSend,
          descripcion
        };
          console.log("PAYLOAD FINAL:", payload);

        try {
          const isEditing = !!editingId;
          const url = isEditing
            ? `/dia_no_laborales/actualizarDiaNoLaboral/${editingId}`
            : '/dia_no_laborales/crearDiaNoLaboral';

          const method = isEditing ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await response.json().catch(() => ({}));

          if (!response.ok) {
            showAlert(data.message || 'Error al guardar el registro.', 'error');
            return;
          }

          showAlert(data.message || (isEditing ? 'Registro actualizado.' : 'Registro creado.'), 'success');
          setTimeout(() => window.location.reload(), 800);

        } catch (error) {
          console.error(error);
          showAlert('Error al procesar la solicitud.', 'error');
        }
      });

      
      btnCancelar.addEventListener('click', () => {
        editingId = null;
        inputId.value = '';
        selectAlcance.disabled = false;
        selectMedico.disabled = false;
        selectSucursal.disabled = false;

        inputFechaInicio.min = hoy;
        inputFechaFin.min = hoy;


        form.reset();

  
        formTitle.textContent = 'Nuevo Día No Laboral';
        btnGuardar.textContent = 'Guardar';
        btnCancelar.style.display = 'none';

        refreshAlcanceUI();
        refreshHorasUI();
      });

    
      document.querySelectorAll('tbody tr').forEach(row => {
        const id = row.dataset.id;

        row.querySelectorAll('button').forEach(btn => {
          const action = btn.dataset.action;

          if (action === 'edit') {
            btn.addEventListener('click', () => {
              editingId = id;
              inputId.value = id;

              inputFechaInicio.min = '';
              inputFechaFin.min = '';

              const tipo = row.dataset.tipo || 'FERIADO';
              const alcanceOriginal = inferAlcanceFromRow(row);
              selectTipo.value = tipo;
              selectAlcance.value = alcanceOriginal;

              refreshAlcanceUI(true);

              selectAlcance.disabled = true;
              selectMedico.value = row.dataset.idmedico || '';
              selectSucursal.value = row.dataset.idsucursal || '';

              inputFechaInicio.value = row.dataset.fechainicio || '';
              inputFechaFin.value = row.dataset.fechafin || '';

              const allDay = (row.dataset.allday || '1').toString();
              const radio = document.querySelector(`input[name="all_day"][value="${allDay}"]`);
              if (radio) radio.checked = true;

              refreshHorasUI(true);
              
              if (allDay === '0') {
                inputHoraInicio.value = row.dataset.horainicio || '';
                inputHoraFin.value = row.dataset.horafin || '';
              } else {
                inputHoraInicio.value = '';
                inputHoraFin.value = '';
              }

              inputDescripcion.value = row.dataset.descripcion || '';

              formTitle.textContent = 'Editar registro';
              btnGuardar.textContent = 'Guardar cambios';
              btnCancelar.style.display = 'inline-block';
              window.scrollTo({ top: 0, behavior: 'smooth' });
            });
          }

          if (action === 'delete') {
            btn.addEventListener('click', async () => {
              if (!confirm('¿Seguro que deseas eliminar este registro?')) return;

              try {
                const response = await fetch(`/dia_no_laborales/eliminarDiaNoLaboral/${id}`, {
                  method: 'DELETE'
                });

                const data = await response.json().catch(() => ({}));

                if (!response.ok) {
                  showAlert(data.message || 'Error al eliminar.', 'error');
                  return;
                }

                showAlert(data.message || 'Registro eliminado.', 'success');
                row.remove();

                if (!document.querySelector('tbody tr')) {
                  const listSection = document.querySelector('.dias-list-section');
                  const emptyMsg = document.createElement('p');
                  emptyMsg.className = 'dias-empty';
                  emptyMsg.textContent = 'No hay días no laborables cargados.';
                  listSection.appendChild(emptyMsg);
                }

              } catch (error) {
                console.error(error);
                showAlert('Error al eliminar.', 'error');
              }
            });
          }
        });
      });

      function showAlert(message, type) {
        let existing = document.querySelector('.dias-alert');
        if (existing) existing.remove();

        const alertDiv = document.createElement('div');
        alertDiv.className = `dias-alert dias-alert-${type}`;
        alertDiv.textContent = message;

        document.querySelector('.dias-card').prepend(alertDiv);
        setTimeout(() => alertDiv.remove(), 4000);
      }
      function inferAlcanceFromRow(row) {
        const idMedico = (row.dataset.idmedico || '').trim();
        const idSucursal = (row.dataset.idsucursal || '').trim();

        if (idMedico) return 'PROFESIONAL';
        if (idSucursal) return 'SUCURSAL';
        return 'GLOBAL';
      }

    });
  
  style.
    .dias-container {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 15px;
    }
    .dias-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      padding: 30px 25px 35px;
    }
    .dias-title {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 25px;
      color: #2c3e50;
      letter-spacing: 0.03em;
    }
    .dias-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1.2fr);
      gap: 30px;
      align-items: flex-start;
    }
    .dias-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #34495e;
    }
    .dias-form-section, .dias-list-section {
      background: #f8fafc;
      border-radius: 10px;
      padding: 18px 18px 20px;
      border: 1px solid #e3e8ef;
    }
    .dias-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .form-group label {
      font-size: 0.9rem;
      color: #475569;
      font-weight: 500;
    }
    .dias-input {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .dias-input:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    .form-actions {
      margin-top: 5px;
      display: flex;
      gap: 10px;
    }
    .btn-primary, .btn-secondary {
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.1s ease;
    }
    .btn-primary {
      background: #3498db;
      color: #fff;
      box-shadow: 0 3px 6px rgba(52, 152, 219, 0.35);
    }
    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.45);
    }
    .btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }
    .btn-secondary:hover {
      background: #cbd5e1;
    }
    .dias-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .dias-table th,
    .dias-table td {
      padding: 8px 10px;
      text-align: left;
    }
    .dias-table thead {
      background: #e2e8f0;
    }
    .dias-table th {
      font-weight: 600;
      color: #1e293b;
    }
    .dias-table tbody tr:nth-child(even) {
      background: #f8fafc;
    }
    .dias-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .dias-link {
      background: none;
      border: none;
      color: #2563eb;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 0;
      text-decoration: underline;
    }
    .dias-btn-danger {
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #ef4444;
      color: #fff;
      transition: background 0.2s ease, transform 0.1s ease;
    }
    .dias-btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
    .dias-empty {
      font-size: 0.9rem;
      color: #64748b;
    }
    .dias-alert {
      margin-bottom: 15px;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .dias-alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    .dias-alert-error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    @media (max-width: 768px) {
      .dias-grid {
        grid-template-columns: 1fr;
      }
      .dias-card {
        padding: 20px 15px 25px;
      }
    }
