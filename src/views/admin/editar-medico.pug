extends ../layout

block content
  .container
    h1.page-title Editar Médico

    form#editarMedicoForm(method="POST" action=`/medico/${medico.id}/editar`)
      .card
        h2.card-title Datos del Médico
        .form-grid
          .form-group
            label(for="id") ID
            input(type="text" id="id" value=medico.ID readonly)
          .form-group
            label(for="nombre") Nombre
            input(type="text" id="nombre" value=medico.nombre readonly)
          .form-group
            label(for="apellido") Apellido
            input(type="text" id="apellido" value=medico.apellido readonly)
          .form-group
            label(for="dni") DNI
            input(type="text" id="dni" value=medico.dni readonly)
          .form-group
            label(for="mail") Correo
            input(type="email" name="mail" id="mail" value=medico.mail required)
          .form-group
            label(for="telefono") Teléfono
            input(type="text" name="telefono" id="telefono" value=medico.telefono required)
        .form-actions
          button.btn.btn-primary(type="button" data-medico-id=medico.ID) Actualizar

      .card
        h2.card-title Especialidades
        table#tablaEspecialidades.table
          thead
            tr
              th ID
              th Especialidad
              th Matrícula
              th Acción
          tbody
            each especialidad in especialidades
              tr
                td= especialidad.id
                td= especialidad.nombre
                td
                  if medico.especialidades.some(esp => esp.id === especialidad.id)
                    p.matricula= medico.especialidades.find(esp => esp.id === especialidad.id).matricula
                  else
                    input.input-matricula(type="text" name=`matricula-${especialidad.id}` id=`matricula-${especialidad.id}` placeholder="Ingrese matrícula")
                td
                  if !medico.especialidades.some(esp => esp.id === especialidad.id)
                    button.btn.btn-add(type="button" data-especialidad-id=especialidad.id data-medico-id=medico.ID) Agregar
                  else
                    button.btn.btn-remove(type="button" data-especialidad-id=especialidad.id data-medico-id=medico.ID) Quitar

block scripts
  script(src='https://code.jquery.com/jquery-3.7.1.min.js')
  script(src='https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js')
  script.
    $(document).ready(function () {
      $('#tablaEspecialidades').DataTable({
        dom: 'frtip',
        order: [[3, 'desc']],
        paging: false,
        language: {
          info: "",
          search: "Buscar especialidades",
        }
      });

      $('.btn-add, .btn-remove').on('click', function() {
        const btn = $(this);
        const especialidadId = btn.data('especialidad-id');
        const medicoId = btn.data('medico-id');
        const isAdding = btn.hasClass('btn-add');
        const url = isAdding 
          ? `/medico/${medicoId}/agregarEspecialidad/${especialidadId}`
          : `/medico/${medicoId}/quitarEspecialidad/${especialidadId}`;

        if (isAdding) {
          const matriculaInput = $(`#matricula-${especialidadId}`);
          const matricula = matriculaInput.val().trim();
          if (!matricula) {
            showAlert('Por favor, ingresa una matrícula.', 'error');
            return;
          }
          if (!/^\d+$/.test(matricula)) {
            showAlert('La matrícula solo puede contener números.', 'error');
            return;
          }
        }

        $.ajax({
          url: url,
          method: 'POST',
          data: isAdding ? JSON.stringify({ matricula: $(`#matricula-${especialidadId}`).val() }) : {},
          contentType: 'application/json',
          success: function() {
            showAlert(isAdding ? 'Especialidad agregada' : 'Especialidad quitada', 'success');
            location.reload();
          },
          error: function(xhr) {
            const errorMessage = xhr.responseJSON ? xhr.responseJSON.message : 'Error al procesar la solicitud';
            showAlert(errorMessage, 'error');
          }
        });
      });

      $('.btn-primary').on('click', function() {
        const medicoId = $(this).data('medico-id');
        const mail = $('#mail').val().trim();
        const telefono = $('#telefono').val().trim();

        if (!mail) {
          showAlert('Por favor, ingresa un correo electrónico.', 'error');
          return;
        }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(mail)) {
          showAlert('Por favor ingresa un email válido.', 'error');
          return;
        }
        if (!telefono) {
          showAlert('Por favor, ingresa un número de teléfono.', 'error');
          return;
        }
        if (!/^\d{10}$/.test(telefono)) {
          showAlert('Por favor ingresa un número de teléfono válido de 10 dígitos.', 'error');
          return;
        }

        $.ajax({
          url: `/medico/${medicoId}/actualizar`,
          method: 'POST',
          data: JSON.stringify({ mail, telefono }),
          contentType: 'application/json',
          success: function() {
            showAlert('Médico actualizado exitosamente', 'success');
            window.location.href = '/medico/lista';
          },
          error: function(xhr) {
            const errorMessage = xhr.responseJSON ? xhr.responseJSON.message : 'Error al actualizar el médico';
            showAlert(errorMessage, 'error');
          }
        });
      });

      function showAlert(message, type) {
        const alertDiv = $('<div>').addClass('alert').addClass(`alert-${type}`).text(message);
        $('.container').prepend(alertDiv);
        setTimeout(() => alertDiv.fadeOut('slow', function() { $(this).remove(); }), 5000);
      }
    });

  block styles
    style.
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .page-title {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        padding: 20px;
      }

      .card-title {
        color: #333;
        font-size: 1.5em;
        margin-bottom: 20px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #666;
      }

      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      .form-group input[readonly] { 
        border: none;
        background-color: transparent;
        font-weight: bold; 
      }
      .form-group input[readonly]:hover {
        cursor:default ;
      }
      .form-actions {
        text-align: right;
        margin-top: 20px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background-color: #0056b3;
      }

      .btn-add {
        background-color: #28a745;
        color: white;
      }

      .btn-add:hover {
        background-color: #218838;
      }

      .btn-remove {
        background-color: #dc3545;
        color: white;
      }

      .btn-remove:hover {
        background-color: #c82333;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th,
      .table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
      }

      .table th {
        background-color: #f8f9fa;
        font-weight: bold;
      }

      .input-matricula {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .matricula {
        font-weight: bold;
      }

      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
      }

      .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
      }

      .alert-error {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }

      .dataTables_wrapper .dataTables_filter input {
        margin-left: 0.5em;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .dataTables_wrapper .dataTables_filter {
        margin-bottom: 10px;
      }