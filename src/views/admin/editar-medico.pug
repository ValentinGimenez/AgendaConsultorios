extends ../layout

block content
  h1 Editar Médico

  form#editarMedicoForm.container(method="POST" action=`/medico/${medico.id}/editar`)
    h2 Datos del Médico
    table.display
      thead
        tr
          th ID
          th Nombre
          th Apellido
          th DNI
          th Correo
          th Teléfono
          th Acciones
      tbody
        tr
          td= medico.ID
          td= medico.nombre
          td= medico.apellido
          td= medico.dni
          td 
            input(type="email" name="mail" id="mail" value=medico.mail required)
          td 
            input(type="text" name="telefono" id="telefono" value=medico.telefono required)
          td 
            a(href=`/medico/${medico.ID}/actualizar`, data-medico-id=medico.ID, class="actualizarBtn") Actualizar
    h2 Especialidades
    table#tablaEspecialidades.display
      thead
        tr
          th ID
          th Especialidad
          th Matrícula
          th Acción
      tbody
        each especialidad in especialidades
          tr
            td= especialidad.id
            td= especialidad.nombre
            td
              if medico.especialidades.some(esp => esp.id === especialidad.id)
                p= medico.especialidades.find(esp => esp.id === especialidad.id).matricula
              else
                input(type="text" name=`matricula-${especialidad.id}` id=`matricula-${especialidad.id}` class="input-matricula" placeholder="Ingrese matrícula")
            td
              if !medico.especialidades.some(esp => esp.id === especialidad.id)
                a(href=`/medico/${medico.ID}/agregarEspecialidad/${especialidad.id}`, 
                  data-especialidad-id=especialidad.id, 
                  data-medico-id=medico.ID , 
                  class="agregar-especialidad-btn") Agregar
              else
                a(href=`/medico/${medico.ID}/quitarEspecialidad/${especialidad.id}`, 
                  data-medico-id=medico.ID, 
                  data-especialidad-id=especialidad.id, 
                  class="quitar-especialidad-btn") Quitar
block scripts
  script(src='https://code.jquery.com/jquery-3.7.1.min.js')
  script(src='https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js')
  script.
    $(document).ready(function () {
      // Inicializar DataTables para la tabla de todas las especialidades
      $('#tablaEspecialidades').DataTable({
        dom: 'frtip', 
        order: [[3, 'des']] ,
        paging: false,
        language: {
          info: "", 
          search: "Buscar especialidades",
        }
      });

      const agregarBtns = document.querySelectorAll('.agregar-especialidad-btn');
      const quitarBtns = document.querySelectorAll('.quitar-especialidad-btn');

      agregarBtns.forEach(btn => {
        btn.addEventListener('click', async (event) => {
          event.preventDefault();
          const especialidadId = parseInt(btn.dataset.especialidadId, 10);
          const medicoId = btn.dataset.medicoId;
          const matriculaInput = document.getElementById(`matricula-${especialidadId}`);
          const matricula = matriculaInput ? matriculaInput.value.trim() : '';
          if (!matricula) {
            alert('Por favor, ingresa una matrícula.');
            return;
          }
          if (!/^\d+$/.test(matricula)) {  // Expresión regular para validar que solo sean números
            alert('La matrícula solo puede contener números.');
            return;
          }
          const url = btn.href;
          try {
            const response = await fetch(url, { 
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ matricula })
              
            });

            if (response.ok) {
              alert('Especialidad agregada');
              location.reload();
            } else {
              const errorData = await response.json();
              alert(errorData.message || 'Error al agregar la especialidad EN EL PUG');
            }
          } catch (error) {
            console.error('Error al agregar la especialidad:', error);
            alert('Error al agregar la especialidad');
          }
        });
      });

      quitarBtns.forEach(btn => {
        btn.addEventListener('click', async (event) => {
          event.preventDefault();
          const especialidadId = btn.dataset.especialidadId;
          const medicoId = btn.dataset.medicoId;
          const url = btn.href;

          try {
            const response = await fetch(url, { method: 'POST' }); 
            if (response.ok) {
              alert('Especialidad quitada');
              location.reload();
            } else {
              const errorData = response.headers.get('content-length') > 0 ? await response.json() : {}; 
              alert(errorData.message || 'Error al quitar la especialidad en el pug');
            }
          } catch (error) {
            console.error('Error al quitar la especialidad:', error);
            alert('Error al quitar la especialidad');
          }
        });
      });

      $('.actualizarBtn').on('click', function(event) {
        event.preventDefault();

        const medicoId = $(this).data('medico-id');
        const mail = $('#mail').val().trim();
        const telefono = $('#telefono').val().trim();

        // Validaciones (puedes agregar más validaciones aquí)
        if (!mail) {
          alert('Por favor, ingresa un correo electrónico.');
          return;
        }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(mail)) {
          alert('Por favor ingresa un email válido.');
          return;
        }
        if (!telefono) {
          alert('Por favor, ingresa un número de teléfono.');
          return;
        }
        if (!/^\d{10}$/.test(telefono)) { 
          alert('Por favor ingresa un número de teléfono válido de 10 dígitos.');
          return;
        }

        try {
          // Enviar la solicitud de actualización al servidor
          fetch(`/medico/${medicoId}/actualizar`, { // Ruta para actualizar el médico
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
              mail, 
              telefono 
            }),
          })
          .then(response => {
            if (response.ok) {
              alert('Médico actualizado exitosamente');
              location.reload();
            } else {
              return response.json().then(errorData => {
                alert('Error al actualizar el médico: ' + (errorData.message || 'Error desconocido'));
              });
            }
          })
          .catch(error => {
            console.error('Error al enviar la solicitud:', error);
            alert('Error al actualizar el médico.');
          });

        } catch (error) {
          console.error('Error al actualizar el médico:', error);
          alert('Error al actualizar el médico.');
        }
      });
    });
  block styles 
    style.
      .dataTables_wrapper .dataTables_paginate .paginate_button {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        color: #333;
        padding: 6px 12px;
        margin: 0 5px;
        cursor: pointer;
        transition: background-color 0.3s ease; 
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background-color: #ddd;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background-color: #007bff;
        color: white;
      }

      #tablaEspecialidades {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      #tablaEspecialidades th, 
      #tablaEspecialidades td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        font-size: 14px;
      }

      #tablaEspecialidades th {
        background-color: #f2f2f2;
        font-weight: bold;
      }

      .agregar-especialidad-btn,
      .quitar-especialidad-btn {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 6px 12px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 6px 4px; 
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s ease; 
      }

      .agregar-especialidad-btn:hover,
      .quitar-especialidad-btn:hover {
        background-color: #3e8e41;
      }

      .input-matricula {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        padding: 10px;
        font-size: 16px;
        width: 100%;
        box-sizing: border-box;
      }

      table.display {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      table.display th, 
      table.display td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center; 
        font-size: 14px;
        align-items: center;
        justify-content: center;
      }


      table.display th {
        background-color: #f2f2f2;
        font-weight: bold;
      }

      table.display td input[type="email"],
      table.display td input[type="text"] {
        width: 100%;
        padding: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }
      td a {
        display: inline-block;
        padding: 5px 10px;
        margin-right: 5px;
        background-color: #007bff; 
        color: white;
        text-decoration: none;
        border-radius: 4px;
      }
      td a:hover {
        background-color: #0056b3; 
      }