extends ../layout

block content
  h1 Lista de Personas

  table#tablaPersonas.display
    thead
      tr
        th ID
        th Nombre y Apellido
        th Correo
        th DNI
        th Teléfono
        th Acciones 
    tbody
      each persona in personas
        tr
          td= persona.ID
          td= persona.nombre + ' ' + persona.apellido
          td= persona.mail
          td= persona.dni
          td= persona.telefono
          td 
            a(href=`/medico/registrar/${persona.ID}`) Registrar Médico 

block scripts
  script(src='https://code.jquery.com/jquery-3.7.1.min.js')
  script(src='https://cdn.datatables.net/2.1.8/js/dataTables.min.js')
  script.
    $(document).ready(function () {
      $('#tablaPersonas').DataTable({
        dom: 'frtip', 
        order: [[0, 'asc']], 
        paging: false,
        language: {
          info: "", 
          search: "Buscar personas",
        }
      });

      $('a[href^="/medico/registrar/"]').on('click', async function(event) {
        event.preventDefault();
        
        const idPersona = $(this).attr('href').split('/').pop();
        const nombreCompleto = $(this).closest('tr').find('td:eq(1)').text().split(' ');
        const nombre = nombreCompleto[0];
        const apellido = nombreCompleto.slice(1).join(' ');
        const dni = $(this).closest('tr').find('td:eq(3)').text();
        const mail = $(this).closest('tr').find('td:eq(2)').text();
        const telefono = $(this).closest('tr').find('td:eq(4)').text(); 
        try {
          const response = await fetch('/medico', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              nombre,
              apellido,
              dni,
              mail,
              telefono,
              idPersona
            }),
          });

          if (response.ok) {
            alert('Médico registrado exitosamente');
              location.reload(); 
          } else {
            const errorData = await response.json();
            alert('Error al registrar el médico: ' + (errorData.message || 'Error desconocido')); 
          }
        } catch (error) {
          console.error('Error al enviar el formulario:', error);
          alert('Error al enviar el formulario.');
        }
      });
    });
  block styles
    style.
        #tablaPersonas_wrapper { 
            border-collapse: collapse;
            width: 100%;
            max-width: 800px; 
            margin: 20px auto; 
            
        }

        th, td {
            border: 1px solid #ddd; 
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2; 
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9; 
        }

        tr:hover{
            background-color: #e9e9e9; 
        }

        td a {
            display: inline-block;
            padding: 5px 10px;
            margin-right: 5px;
            background-color: #007bff; 
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }

        td a:hover {
            background-color: #0056b3; 
        }
        #tablaPersonas_wrapper .dt-search {
            padding-bottom: 20px;
            width: 100%; 
            text-align: right; 
        } 
