extends ../layout

block content
  h1 Editar Paciente

  form#editarPacienteForm.container(method="POST" action=`/paciente/${paciente.id}/editar`)
    h2 Datos del Paciente
    table.display
      thead
        tr
          th ID
          th Nombre
          th Apellido
          th DNI
          th Correo
          th Teléfono
          th Obra Social
          th Acciones
      tbody
        tr
          td= paciente.ID
          td= paciente.nombre
          td= paciente.apellido
          td= paciente.dni
          td 
            input(type="email" name="mail" id="mail" value=paciente.mail required)
          td 
            input(type="text" name="telefono" id="telefono" value=paciente.telefono required)
          td 
            select(name="obrasocial" id="obrasocial" required)
              each obraSocial in obrasSociales
                option(value=obraSocial.id, selected=(obraSocial.id == paciente.idObraSocial))= obraSocial.nombre 
          td 
            a(href=`/paciente/${paciente.ID}/actualizar`, data-paciente-id=paciente.ID, class="actualizarBtn") Actualizar
block scripts
  script(src='https://code.jquery.com/jquery-3.7.1.min.js')
  script(src='https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js')
  script.
    $(document).ready(function () {
      // Inicializar DataTables para la tabla de consultas (si la tienes)
      // $('#tablaConsultas').DataTable({ ... }); 

      $('.actualizarBtn').on('click', function(event) {
        event.preventDefault();

        const pacienteId = $(this).data('paciente-id');
        const mail = $('#mail').val().trim();
        const telefono = $('#telefono').val().trim();
        const idObraSocial = $('#obrasocial').val(); // Obtener el ID de la obra social

        // Validaciones (puedes agregar más validaciones aquí)
        if (!mail) {
          alert('Por favor, ingresa un correo electrónico.');
          return;
        }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(mail)) {
          alert('Por favor ingresa un email válido.');
          return;
        }
        if (!telefono) {
          alert('Por favor, ingresa un número de teléfono.');
          return;
        }
        if (!/^\d{10}$/.test(telefono)) { 
          alert('Por favor ingresa un número de teléfono válido de 10 dígitos.');
          return;
        }

        try {
          // Enviar la solicitud de actualización al servidor
          fetch(`/paciente/${pacienteId}/actualizar`, { 
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
              mail, 
              telefono,
              idObraSocial 
            }),
          })
          .then(response => {
            if (response.ok) {
              alert('Paciente actualizado exitosamente');
              location.reload();
            } else {
              return response.json().then(errorData => {
                alert('Error al actualizar el paciente: ' + (errorData.message || 'Error desconocido'));
              });
            }
          })
          .catch(error => {
            console.error('Error al enviar la solicitud:', error);
            alert('Error al actualizar el paciente.');
          });

        } catch (error) {
          console.error('Error al actualizar el paciente:', error);
          alert('Error al actualizar el paciente.');
        }
      });
    });
  block styles
    style.
      table.display {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      table.display th, 
      table.display td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center; 
        font-size: 14px;
        align-items: center;
        justify-content: center;
      }

      table.display th {
        background-color: #f2f2f2;
        font-weight: bold;
      }

      table.display td input[type="email"],
      table.display td input[type="text"] {
        width: 100%;
        padding: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }

      td a {
        display: inline-block;
        padding: 5px 10px;
        margin-right: 5px;
        background-color: #007bff; 
        color: white;
        text-decoration: none;
        border-radius: 4px;
      }

      td a:hover {
        background-color: #0056b3; 
      }