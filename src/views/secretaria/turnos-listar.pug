extends ../layout

block content
  - const f = filtros || { fecha: '', idMedico: 'all', idEspecialidad: 'all', idEstadoTurno: 'all' }
  - const ms = Array.isArray(medicos) ? medicos : []
  - const esps = Array.isArray(especialidades) ? especialidades : []
  - const ests = Array.isArray(estados) ? estados : []
  - const ts = Array.isArray(turnos) ? turnos : []

  .secretaria-container
    .filters-section
      .card.search-card
        .card-header
          i.icon üìÖ
          h2.card-title B√∫squeda por Fecha
        .card-body
          form#formFecha(method="GET", action="/turno/listar")
            .form-row
              .field
                label(for="fecha") Seleccionar fecha
                input#fecha(type="date", name="fecha", value=f.fecha, required)
              .field.field-button
                button.btn.btn-primary(type="submit")
                  span Buscar
                  i.icon-search üîç
            input(type="hidden", name="idMedico", value=f.idMedico)
            input(type="hidden", name="idEspecialidad", value=f.idEspecialidad)
            input(type="hidden", name="idEstadoTurno", value=f.idEstadoTurno)

      .card.filters-card
        .card-header
          i.icon üîç
          h2.card-title Filtros Avanzados
        .card-body
          form#filtrosForm(method="GET", action="/turno/listar")
            input(type="hidden", name="fecha", value=f.fecha)

            .form-row
              .field
                label(for="medico") M√©dico
                .select-wrapper
                  select#medico(name="idMedico")
                    option(value="all", selected=f.idMedico=='all') Todos los m√©dicos
                    each m in ms
                      option(value=m.id || m.medico_id, selected=String(m.id || m.medico_id) === String(f.idMedico))
                        = m.nombre || m.nombre_completo

              .field
                label(for="especialidad") Especialidad
                .select-wrapper
                  select#especialidad(name="idEspecialidad")
                    option(value="all", selected=f.idEspecialidad=='all') Todas las especialidades
                    each e in esps
                      option(value=e.id, selected=String(e.id) === String(f.idEspecialidad))= e.nombre

              .field
                label(for="estado") Estado del Turno
                .select-wrapper
                  select#estado(name="idEstadoTurno")
                    option(value="all", selected=f.idEstadoTurno=='all') Todos los estados
                    each st in ests
                      option(value=st.id, selected=String(st.id) === String(f.idEstadoTurno))= st.descripcion

            .form-row
              .field.field-button
                button.btn.btn-primary(type="submit") Aplicar

    .card.table-card
      .card-header
        i.icon üìã
        h2.card-title Turnos del #{f.fecha || 'd√≠a seleccionado'}
      .card-body
        .table-wrapper
          table#tablaTurnos.display
            thead
              tr
                th Hora
                th Fin
                th M√©dico
                th Especialidad
                th Paciente
                th Tipo
                th Motivo
                th Estado
                th Acciones
            tbody
              each t in ts
                - const acc = Array.isArray(t.acciones) ? t.acciones : []
                tr(data-estado=t.idEstadoTurno)
                  td.time-cell= t.hora_inicio
                  td.time-cell= t.hora_fin
                  td.medico-cell= t.medico
                  td= t.especialidad
                  td.paciente-cell= t.paciente || '-'
                  
                  td
                    if t.tipo === 'sobreturno'
                      span.badge.badge-sobreturno Sobret.
                    else
                      span.text-muted Normal

                  td.motivo-cell= t.motivo_consulta || '-'
                  
                  td
                    span.badge(class=`badge-estado-${t.idEstadoTurno}`)= t.estado
                  
                  td.acciones
                    .action-buttons
                      if acc.length
                        each a in acc
                          form.inline-form(method="POST", action=`/turno/${t.ID}/estado`)
                            input(type="hidden", name="idEstadoTurno", value=a.to)
                            button.btn.btn-icon(type="submit", class=a.class, title=a.title)= a.icon
                      else
                        span(style="color:#9ca3af") ‚Äî

  script(src='https://code.jquery.com/jquery-3.7.1.min.js')
  script(src='https://cdn.datatables.net/2.1.8/js/dataTables.min.js')
  script.
    $(document).ready(function () {
      $('#tablaTurnos').DataTable({
        dom: 'frtip', 
        pageLength: 50,
        order: [[0, 'asc']],
        language: {
          search: "Buscar:",
          zeroRecords: "No hay turnos ocupados para mostrar",
          info: "Mostrando _START_ a _END_ de _TOTAL_ turnos",
          infoEmpty: "No hay turnos disponibles",
          infoFiltered: "(filtrado)",
          paginate: { first: "<<", last: ">>", next: ">", previous: "<" }
        },
        responsive: true,
        columnDefs: [
          { targets: -1, orderable: false } 
        ]
      });

      $('form.inline-form button').on('click', function(e) {
        const action = $(this).attr('title');
        if (!confirm(`¬øConfirmar acci√≥n: ${action}?`)) {
          e.preventDefault();
          return false;
        }
      });

      const medicoSel = document.getElementById('medico');
      const espSel = document.getElementById('especialidad');

      medicoSel.addEventListener('change', async () => {
        const medicoId = medicoSel.value;
        espSel.innerHTML = '<option value="all">Todas las especialidades</option>';
        if (medicoId === 'all') return;
        const res = await fetch(`/medico_especialidad/obtenerEspecialidad/${medicoId}`);
        const data = await res.json();
        data.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.id;
          opt.textContent = e.nombre;
          espSel.appendChild(opt);
        });
        espSel.value = 'all';
      });

      espSel.addEventListener('change', async () => {
        const espId = espSel.value;
        medicoSel.innerHTML = '<option value="all">Todos los m√©dicos</option>';
        if (espId === 'all') return;
        const res = await fetch(`/medico_especialidad/obtenerMedicos/${espId}`);
        const data = await res.json();
        data.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id || m.medico_id;
          opt.textContent = m.nombre || m.nombre_completo;
          medicoSel.appendChild(opt);
        });
        medicoSel.value = 'all';
      });

      const fechaInput = document.getElementById('fecha');
      if (fechaInput && !fechaInput.value) {
        fechaInput.value = new Date().toISOString().split('T')[0];
      }
    });

  style.
    :root {
      --primary-color: #2563eb;
      --primary-dark: #1e40af;
      --success-color: #10b981;
      --info-color: #06b6d4;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --purple-color: #8b5cf6;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --border-radius: 12px;
    }
    * { box-sizing: border-box; }
    
    .secretaria-container { 
        max-width: 98%; 
        margin: 0 auto; 
        padding: 24px; 
        background: var(--gray-50); 
        min-height: 100vh; 
    }
    
    .filters-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .card { background: white; border-radius: var(--border-radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
    .card-header { display: flex; align-items: center; gap: 12px; padding: 20px 24px; background: linear-gradient(to right, var(--gray-50), white); border-bottom: 2px solid var(--gray-100); }
    .card-title { font-size: 1.25em; font-weight: 600; color: #111827; margin: 0; }
    .card-body { padding: 24px; }
    .form-row { display: flex; gap: 16px; flex-wrap: wrap; }
    .field { flex: 1; min-width: 200px; }
    .field label { display: block; margin-bottom: 8px; font-weight: 500; }
    input[type="date"], select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--gray-200); }
    .field-button { display: flex; align-items: flex-end; justify-content: flex-end; }
    
    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; color: white; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-weight: 600; }
    .btn-primary { background: var(--primary-color); }
    
    .btn-icon { padding: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
    
    .btn-confirmar { background: var(--success-color); }
    .btn-cancelar { background: var(--danger-color); }
    .btn-presente { background: var(--info-color); }
    .btn-ausente { background: var(--warning-color); }
    .btn-consulta { background: var(--purple-color); }
    .btn-atendido { background: #065f46; }
    .btn-liberar { background: #f43f5e; }

    .table-card { grid-column: 1 / -1; }
    .table-wrapper { overflow-x: auto; }
    
    table.display { width: 100% !important; border-collapse: separate; border-spacing: 0; }
    table.display th { background: var(--gray-50); padding: 12px; border-bottom: 2px solid var(--gray-200); text-transform: uppercase; font-size: 0.85em; white-space: nowrap; }
    
    table.display td { 
        padding: 12px; 
        border-bottom: 1px solid var(--gray-100); 
        vertical-align: middle; 
        white-space: normal !important; 
    }
    
    .time-cell { font-family: monospace; font-weight: bold; color: var(--primary-color); white-space: nowrap !important; }
    
    .motivo-cell { 
        min-width: 150px; 
        max-width: 300px; 
        font-style: italic; 
        color: #555; 
        font-size: 0.9em;
    }

    .acciones { min-width: 160px; }
    .action-buttons { display: flex; gap: 4px; flex-wrap: wrap; }
    
    .badge { padding: 4px 10px; border-radius: 99px; font-weight: 600; font-size: 0.75em; text-transform: uppercase; white-space: nowrap; }
    .badge-sobreturno { background: #ffedd5; color: #c2410c; }
    .text-muted { color: #9ca3af; font-size: 0.9em; }
    .badge-estado-2 { background: #fef3c7; color: #d97706; }
    .badge-estado-3 { background: #d1fae5; color: #047857; }
    .badge-estado-4 { background: #dcfce7; color: #15803d; }
    .badge-estado-6 { background: #fee2e2; color: #b91c1c; }
    .badge-estado-8 { background: #e0f2fe; color: #0369a1; }
    .badge-estado-9 { background: #f3e8ff; color: #7e22ce; }
    
    .dataTables_wrapper .dataTables_filter input { border: 2px solid var(--gray-200); border-radius: 8px; padding: 6px 12px; margin-left: 8px; }
    .dataTables_wrapper .dataTables_paginate .paginate_button { background: #f3f4f6 !important; border: none !important; border-radius: 6px; }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current { background: var(--primary-color) !important; color: white !important; }