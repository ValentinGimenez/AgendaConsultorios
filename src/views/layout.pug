doctype html
html(lang="es")
  head
    meta(charset="utf-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    meta(name="description" content="Sarumed - Sistema integral de gestión médica")
    title Sarumed

    link(rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css")
    
    script(src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.js")
    script(src="https://cdn.jsdelivr.net/npm/@fullcalendar/web-component@6.1.15/index.global.min.js")
    script(src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js")

    block scripts

    style.
      :root {
        --color-primary: #0f172a;
        --color-primary-light: #1e293b;
        --color-accent: #6366f1;
        --color-accent-light: #eff6ff;
        --color-background: #f8fafc;
        --color-surface: #ffffff;
        --color-text-primary: #0f172a;
        --color-text-secondary: #64748b;
        --color-text-muted: #94a3b8;
        --color-border: #e2e8f0;
        --color-danger: #ef4444;
        --color-success: #10b981;
        
        --sidebar-width: 280px;
        --header-height: 60px;
        
        --shadow-soft: 0 1px 3px rgba(0, 0, 0, 0.06);
        --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        --radius: 8px;
      }

      *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
        background: var(--color-background);
        color: var(--color-text-primary);
        line-height: 1.6;
        min-height: 100vh;
      }

      .app-layout { display: flex; min-height: 100vh; }

      .sidebar {
        width: var(--sidebar-width);
        background: var(--color-surface);
        border-right: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0; left: 0; height: 100vh;
        z-index: 100;
        transition: transform var(--transition);
      }

      .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--color-border); }
      
      .sidebar-logo { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; color: var(--color-text-primary); }
      
      .sidebar-logo-icon {
        width: 40px; height: 40px;
        background: var(--color-accent);
        border-radius: var(--radius);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; color: white;
      }

      .sidebar-logo-title { font-weight: 700; font-size: 1.125rem; color: var(--color-text-primary); line-height: 1.2; }
      
      .sidebar-nav { flex: 1; overflow-y: auto; padding: 1rem 0; }
      .sidebar-section { margin-bottom: 1.5rem; }
      .sidebar-section-title {
        font-size: 0.6875rem; font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.05em; color: var(--color-text-muted);
        padding: 0 1.5rem; margin-bottom: 0.5rem;
      }
      .sidebar-menu { list-style: none; }
      .sidebar-menu-item { margin: 0.125rem 0.75rem; }

      .sidebar-link {
        display: flex; align-items: center; gap: 0.75rem;
        padding: 0.625rem 0.75rem;
        color: var(--color-text-secondary);
        text-decoration: none; font-size: 0.875rem; font-weight: 500;
        border-radius: var(--radius); transition: all var(--transition);
      }

      .sidebar-link:hover { background: var(--color-background); color: var(--color-text-primary); }
      .sidebar-link.active { background: var(--color-accent-light); color: var(--color-accent); }

      .sidebar-link-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

      .sidebar-footer { border-top: 1px solid var(--color-border); padding: 1rem; }
      .sidebar-user { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: var(--radius); transition: background var(--transition); }
      .sidebar-user-avatar {
        width: 40px; height: 40px; border-radius: 50%;
        background: var(--color-accent); color: white;
        display: flex; align-items: center; justify-content: center;
        font-weight: 600; font-size: 0.875rem; text-transform: uppercase; flex-shrink: 0;
      }
      .sidebar-user-info { flex: 1; min-width: 0; }
      .sidebar-user-name { font-weight: 600; font-size: 0.875rem; color: var(--color-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .sidebar-user-role { font-size: 0.75rem; color: var(--color-text-muted); text-transform: capitalize; }
      
      .sidebar-logout {
        display: flex; align-items: center; gap: 0.75rem; width: 100%;
        padding: 0.625rem 0.75rem; margin-top: 0.5rem;
        color: var(--color-text-secondary); text-decoration: none;
        font-size: 0.875rem; font-weight: 500; border-radius: var(--radius);
        transition: all var(--transition); background: transparent; border: none; cursor: pointer;
      }
      .sidebar-logout:hover { background: #fef2f2; color: var(--color-danger); }

      .main-wrapper { flex: 1; margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; }
      
      .main-wrapper.no-sidebar { margin-left: 0; }

      .mobile-header {
        display: none; align-items: center; justify-content: space-between;
        padding: 1rem 1.5rem; background: var(--color-surface);
        border-bottom: 1px solid var(--color-border);
        position: sticky; top: 0; z-index: 50;
      }
      .mobile-menu-btn {
        width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
        border: none; background: var(--color-background); border-radius: var(--radius);
        cursor: pointer; color: var(--color-text-primary);
      }
      
      .public-header {
        display: flex; align-items: center; justify-content: center;
        padding: 1rem 1.5rem; background: var(--color-surface);
        border-bottom: 1px solid var(--color-border);
      }
      .public-logo { font-weight: 800; font-size: 1.5rem; color: var(--color-accent); letter-spacing: -0.5px; }


      main { flex: 1; padding: 2rem; max-width: 1400px; width: 100%; margin: 0 auto; }
      .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 90; opacity: 0; transition: opacity var(--transition); }
      .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }

      @media (max-width: 1024px) {
        .sidebar { transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay.open { display: block; opacity: 1; }
        .main-wrapper { margin-left: 0; }
        .mobile-header { display: flex; }
        main { padding: 1.5rem; }
      }

  body
    .app-layout
      if user
        .sidebar-overlay#sidebarOverlay(onclick="toggleSidebar()")

        aside.sidebar#sidebar
          .sidebar-header
            a.sidebar-logo(href="/")
              .sidebar-logo-text
                span.sidebar-logo-title SARUMED

          nav.sidebar-nav
              - const p = currentPath || ''
              - const isActive = (path) => p === path || (p && p.startsWith(path + '/'))
              
              if user.rol === 'secretaria'
                .sidebar-section
                  .sidebar-section-title FUNCIONANDO CREO
                  ul.sidebar-menu
                    li.sidebar-menu-item
                      a.sidebar-link(href="/turno/listar" class=isActive('/turno/listar') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            rect(x="3" y="4" width="18" height="18" rx="2" ry="2")
                            line(x1="16" y1="2" x2="16" y2="6")
                            line(x1="8" y1="2" x2="8" y2="6")
                            line(x1="3" y1="10" x2="21" y2="10")
                        span Calendario de Turnos

                    li.sidebar-menu-item
                      a.sidebar-link(href="/paciente/identificar" class=isActive('/paciente/identificar') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            rect(x="3" y="4" width="18" height="18" rx="2" ry="2")
                            line(x1="16" y1="2" x2="16" y2="6")
                            line(x1="8" y1="2" x2="8" y2="6")
                            line(x1="3" y1="10" x2="21" y2="10")
                        span Programar Turno
                    li.sidebar-menu-item
                      a.sidebar-link(href="/paciente/lista" class=isActive('/paciente/lista') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            path(d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2")
                            circle(cx="9" cy="7" r="4")
                            path(d="M23 21v-2a4 4 0 0 0-3-3.87")
                            path(d="M16 3.13a4 4 0 0 1 0 7.75")
                        span Pacientes                        
                .sidebar-section
                  .sidebar-section-title EN PROCESO
                  ul.sidebar-menu                    
                    li.sidebar-menu-item
                      a.sidebar-link(href="/turno/lista-espera" class=isActive('/turno/lista-espera') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            path(d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01")
                        span Lista de Espera

                    li.sidebar-menu-item
                      a.sidebar-link(href="/turno/sobreturnos" class=isActive('/turno/sobreturnos') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            circle(cx="12" cy="12" r="10")
                            polyline(points="12 6 12 12 16 14")
                        span Sobreturnos

                    li.sidebar-menu-item
                      a.sidebar-link(href="/turno/transferir" class=isActive('/turno/transferir') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            path(d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4")
                        span Transferir Turnos
                .sidebar-section
                  .sidebar-section-title DUDOSO SI VA ACA
                  ul.sidebar-menu   
                    li.sidebar-menu-item
                      a.sidebar-link(href="/paciente/personas" class=isActive('/paciente/personas') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            rect(x="3" y="4" width="18" height="18" rx="2" ry="2")
                            line(x1="16" y1="2" x2="16" y2="6")
                            line(x1="8" y1="2" x2="8" y2="6")
                            line(x1="3" y1="10" x2="21" y2="10")
                        span Asignar Rol

              if user.rol === 'admin'
                .sidebar-section
                  .sidebar-section-title Administración
                  ul.sidebar-menu
                    li.sidebar-menu-item
                      a.sidebar-link(href="/medico/lista" class=isActive('/medico/lista') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            path(d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2")
                            circle(cx="12" cy="7" r="4")
                        span Médicos
                    
                    li.sidebar-menu-item
                      a.sidebar-link(href="/medico/nuevo" class=isActive('/medico/nuevo') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            circle(cx="12" cy="12" r="10")
                            line(x1="12" y1="8" x2="12" y2="16")
                            line(x1="8" y1="12" x2="16" y2="12")
                        span Nuevo Médico
                    
                    li.sidebar-menu-item
                      a.sidebar-link(href="/medico/personas" class=isActive('/medico/personas') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                             rect(x="3" y="4" width="18" height="18" rx="2" ry="2")
                             line(x1="16" y1="2" x2="16" y2="6")
                             line(x1="8" y1="2" x2="8" y2="6")
                        span Asignar Rol
                    
                    li.sidebar-menu-item
                      a.sidebar-link(href="/dia_no_laborales/lista" class=isActive('/dia_no_laborales') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            circle(cx="12" cy="12" r="10")
                            line(x1="4.93" y1="4.93" x2="19.07" y2="19.07")
                        span Días No Laborales

              if user.rol === 'paciente'
                .sidebar-section
                  .sidebar-section-title Mis Gestiones
                  ul.sidebar-menu
                    li.sidebar-menu-item
                      a.sidebar-link(href="/turno/mis-turnos" class=isActive('/turno/mis-turnos') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            path(d="M22 11.08V12a10 10 0 1 1-5.93-9.14")
                            polyline(points="22 4 12 14.01 9 11.01")
                        span Mis Turnos
                    
                    li.sidebar-menu-item
                      a.sidebar-link(href="/turno/solicitar" class=isActive('/turno/solicitar') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            path(d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z")
                            polyline(points="14 2 14 8 20 8")
                            line(x1="12" y1="18" x2="12" y2="12")
                            line(x1="9" y1="15" x2="15" y2="15")
                        span Solicitar Turno

                    li.sidebar-menu-item
                      a.sidebar-link(href="/historia-clinica" class=isActive('/historia-clinica') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            path(d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z")
                        span Historia Clínica

                    li.sidebar-menu-item
                      a.sidebar-link(href="/perfil" class=isActive('/perfil') ? 'active' : '')
                        span.sidebar-link-icon
                          svg.icon(viewBox="0 0 24 24")
                            path(d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2")
                            circle(cx="12" cy="7" r="4")
                        span Perfil

          .sidebar-footer
            .sidebar-user
              .sidebar-user-avatar #{user.nombre ? user.nombre.charAt(0) : 'U'}
              .sidebar-user-info
                .sidebar-user-name #{user.nombre || 'Usuario'}
                .sidebar-user-role #{user.rol || 'Rol'}
            
            a.sidebar-logout(href="/usuario/logout")
              svg.icon(viewBox="0 0 24 24")
                path(d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4")
                polyline(points="16 17 21 12 16 7")
                line(x1="21" y1="12" x2="9" y2="12")
              span Cerrar Sesión

      .main-wrapper(class=!user ? 'no-sidebar' : '')
        
        if user
          header.mobile-header
            button.mobile-menu-btn(type="button" onclick="toggleSidebar()")
              svg.icon(viewBox="0 0 24 24")
                line(x1="3" y1="12" x2="21" y2="12")
                line(x1="3" y1="6" x2="21" y2="6")
                line(x1="3" y1="18" x2="21" y2="18")
            span.mobile-logo Sarumed
            .sidebar-user-avatar(style="width: 32px; height: 32px; font-size: 0.75rem") #{user.nombre ? user.nombre.charAt(0) : 'U'}
        else
          header.public-header
            span.public-logo SARUMED

        main
          block content

    if user
      script.
        function toggleSidebar() {
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('sidebarOverlay');
          
          sidebar.classList.toggle('open');
          overlay.classList.toggle('open');
          
          if (sidebar.classList.contains('open')) {
            document.body.style.overflow = 'hidden';
          } else {
            document.body.style.overflow = '';
          }
        }

        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar && sidebar.classList.contains('open')) {
              sidebar.classList.remove('open');
              overlay.classList.remove('open');
              document.body.style.overflow = '';
            }
          }
        });

        window.addEventListener('resize', function() {
          if (window.innerWidth > 1024) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if(sidebar) {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
                document.body.style.overflow = '';
            }
          }
        });